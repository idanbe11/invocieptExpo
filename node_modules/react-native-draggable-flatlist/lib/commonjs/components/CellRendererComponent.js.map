{"version":3,"names":["CellRendererComponent","props","item","index","onLayout","children","rest","currentIndexAnim","useSharedValue","useEffect","requestAnimationFrame","value","viewRef","useRef","useRefs","cellDataRef","propsRef","containerRef","useAnimatedValues","horizontalAnim","scrollOffset","useDraggableFlatListContext","activeKey","keyExtractor","horizontal","key","offset","size","translate","useCellTranslate","cellOffset","cellSize","cellIndex","indexRef","indexHasChanged","current","dragInProgress","isActive","animStyle","useAnimatedStyle","_translate","transform","translateX","translateY","updateCellMeasurements","useStableCallback","onSuccess","x","y","w","h","isWeb","set","measurements","onFail","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","baseStyle","useMemo","elevation","zIndex","flexDirection","style","typedMemo"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\nimport {\n  LayoutChangeEvent,\n  MeasureLayoutOnSuccessCallback,\n  StyleProp,\n  ViewStyle,\n} from \"react-native\";\nimport Animated, {\n  useAnimatedStyle,\n  useSharedValue,\n} from \"react-native-reanimated\";\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\nimport { isWeb } from \"../constants\";\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\nimport { typedMemo } from \"../utils\";\nimport { useRefs } from \"../context/refContext\";\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\nimport CellProvider from \"../context/cellContext\";\nimport { useStableCallback } from \"../hooks/useStableCallback\";\n\ntype Props<T> = {\n  item: T;\n  index: number;\n  children: React.ReactNode;\n  onLayout?: (e: LayoutChangeEvent) => void;\n  style?: StyleProp<ViewStyle>;\n};\n\nfunction CellRendererComponent<T>(props: Props<T>) {\n  const { item, index, onLayout, children, ...rest } = props;\n\n  const currentIndexAnim = useSharedValue(index);\n\n  useEffect(() => {\n    // If we set the index immediately the newly-ordered data can get out of sync\n    // with the activeIndexAnim, and cause the wrong item to momentarily become the\n    // \"active item\", which causes a flicker.\n    requestAnimationFrame(() => {\n      currentIndexAnim.value = index;\n    });\n  }, [index]);\n\n  const viewRef = useRef<Animated.View>(null);\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\n\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\n  const {\n    activeKey,\n    keyExtractor,\n    horizontal,\n  } = useDraggableFlatListContext<T>();\n\n  const key = keyExtractor(item, index);\n  const offset = useSharedValue(-1);\n  const size = useSharedValue(-1);\n\n  const translate = useCellTranslate({\n    cellOffset: offset,\n    cellSize: size,\n    cellIndex: currentIndexAnim,\n  });\n\n  const indexRef = useRef(index);\n  const indexHasChanged = index !== indexRef.current;\n  indexRef.current = index;\n\n  const dragInProgress = !!activeKey && !indexHasChanged;\n  const isActive = dragInProgress && activeKey === key;\n\n  const animStyle = useAnimatedStyle(() => {\n    const _translate = dragInProgress ? translate.value : 0;\n    return {\n      transform: [\n        horizontalAnim.value\n          ? { translateX: _translate }\n          : { translateY: _translate },\n      ],\n    };\n  }, [dragInProgress, translate]);\n\n  const updateCellMeasurements = useStableCallback(() => {\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\n      if (isWeb && horizontal) x += scrollOffset.value;\n      const cellOffset = horizontal ? x : y;\n      const cellSize = horizontal ? w : h;\n      cellDataRef.current.set(key, {\n        measurements: { size: cellSize, offset: cellOffset },\n      });\n\n      size.value = cellSize;\n      offset.value = cellOffset;\n    };\n\n    const onFail = () => {\n      if (propsRef.current?.debug) {\n        console.log(`## on measure fail, index: ${index}`);\n      }\n    };\n\n    const containerNode = containerRef.current;\n    const viewNode = viewRef.current;\n    const nodeHandle = containerNode;\n\n    if (viewNode && nodeHandle) {\n      //@ts-ignore\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\n    }\n  });\n\n  useEffect(() => {\n    if (isWeb) {\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\n      requestAnimationFrame(() => {\n        updateCellMeasurements();\n      });\n    }\n  }, [index, updateCellMeasurements]);\n\n  const onCellLayout = useStableCallback((e: LayoutChangeEvent) => {\n    updateCellMeasurements();\n    if (onLayout) onLayout(e);\n  });\n\n  const baseStyle = useMemo(() => {\n    return {\n      elevation: isActive ? 1 : 0,\n      zIndex: isActive ? 999 : 0,\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\n    };\n  }, [isActive, horizontal]);\n\n  // changing zIndex may crash android, but seems to work ok as of RN 68:\n  // https://github.com/facebook/react-native/issues/28751\n\n  return (\n    <Animated.View\n      {...rest}\n      ref={viewRef}\n      onLayout={onCellLayout}\n      style={[\n        props.style,\n        baseStyle,\n        dragInProgress ? animStyle : { transform: [] },\n      ]}\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\n    >\n      <CellProvider isActive={isActive}>{children}</CellProvider>\n    </Animated.View>\n  );\n}\n\nexport default typedMemo(CellRendererComponent);\n"],"mappings":"mWAAA,qDAOA,uFAIA,6EACA,uCACA,2DACA,+BACA,iDACA,qEACA,2EACA,6D,ynCAUA,QAASA,sBAAT,CAAkCC,KAAlC,CAAmD,IACzCC,KADyC,CACID,KADJ,CACzCC,IADyC,CACnCC,KADmC,CACIF,KADJ,CACnCE,KADmC,CAC5BC,QAD4B,CACIH,KADJ,CAC5BG,QAD4B,CAClBC,QADkB,CACIJ,KADJ,CAClBI,QADkB,CACLC,IADK,uCACIL,KADJ,yCAGjD,GAAMM,iBAAgB,CAAG,GAAAC,qCAAA,EAAeL,KAAf,CAAzB,CAEA,GAAAM,gBAAA,EAAU,UAAM,CAIdC,qBAAqB,CAAC,UAAM,CAC1BH,gBAAgB,CAACI,KAAjB,CAAyBR,KAAzB,CACD,CAFoB,CAArB,CAGD,CAPD,CAOG,CAACA,KAAD,CAPH,EASA,GAAMS,QAAO,CAAG,GAAAC,aAAA,EAAsB,IAAtB,CAAhB,CAdiD,aAeD,GAAAC,mBAAA,GAfC,CAezCC,WAfyC,UAezCA,WAfyC,CAe5BC,QAf4B,UAe5BA,QAf4B,CAelBC,YAfkB,UAelBA,YAfkB,wBAiBR,GAAAC,uCAAA,GAjBQ,CAiBzCC,cAjByC,oBAiBzCA,cAjByC,CAiBzBC,YAjByB,oBAiBzBA,YAjByB,2BAsB7C,GAAAC,qDAAA,GAtB6C,CAmB/CC,SAnB+C,uBAmB/CA,SAnB+C,CAoB/CC,YApB+C,uBAoB/CA,YApB+C,CAqB/CC,UArB+C,uBAqB/CA,UArB+C,CAwBjD,GAAMC,IAAG,CAAGF,YAAY,CAACrB,IAAD,CAAOC,KAAP,CAAxB,CACA,GAAMuB,OAAM,CAAG,GAAAlB,qCAAA,EAAe,CAAC,CAAhB,CAAf,CACA,GAAMmB,KAAI,CAAG,GAAAnB,qCAAA,EAAe,CAAC,CAAhB,CAAb,CAEA,GAAMoB,UAAS,CAAG,GAAAC,kCAAA,EAAiB,CACjCC,UAAU,CAAEJ,MADqB,CAEjCK,QAAQ,CAAEJ,IAFuB,CAGjCK,SAAS,CAAEzB,gBAHsB,CAAjB,CAAlB,CAMA,GAAM0B,SAAQ,CAAG,GAAApB,aAAA,EAAOV,KAAP,CAAjB,CACA,GAAM+B,gBAAe,CAAG/B,KAAK,GAAK8B,QAAQ,CAACE,OAA3C,CACAF,QAAQ,CAACE,OAAT,CAAmBhC,KAAnB,CAEA,GAAMiC,eAAc,CAAG,CAAC,CAACd,SAAF,EAAe,CAACY,eAAvC,CACA,GAAMG,SAAQ,CAAGD,cAAc,EAAId,SAAS,GAAKG,GAAjD,CAEA,GAAMa,UAAS,CAAG,GAAAC,uCAAA,iCAAuB,CACvC,GAAMC,WAAU,CAAGJ,cAAc,CAAGR,SAAS,CAACjB,KAAb,CAAqB,CAAtD,CACA,MAAO,CACL8B,SAAS,CAAE,CACTtB,cAAc,CAACR,KAAf,CACI,CAAE+B,UAAU,CAAEF,UAAd,CADJ,CAEI,CAAEG,UAAU,CAAEH,UAAd,CAHK,CADN,CAAP,CAOD,CATiB,6BAnECJ,cAmED,WAnEkBR,SAmElB,gBAhEJT,cAgEI,mbASf,CAACiB,cAAD,CAAiBR,SAAjB,CATe,CAAlB,CAWA,GAAMgB,uBAAsB,CAAG,GAAAC,oCAAA,EAAkB,UAAM,CACrD,GAAMC,UAAyC,CAAG,QAA5CA,UAA4C,CAACC,CAAD,CAAIC,CAAJ,CAAOC,CAAP,CAAUC,CAAV,CAAgB,CAChE,GAAIC,gBAAA,EAAS3B,UAAb,CAAyBuB,CAAC,EAAI3B,YAAY,CAACT,KAAlB,CACzB,GAAMmB,WAAU,CAAGN,UAAU,CAAGuB,CAAH,CAAOC,CAApC,CACA,GAAMjB,SAAQ,CAAGP,UAAU,CAAGyB,CAAH,CAAOC,CAAlC,CACAnC,WAAW,CAACoB,OAAZ,CAAoBiB,GAApB,CAAwB3B,GAAxB,CAA6B,CAC3B4B,YAAY,CAAE,CAAE1B,IAAI,CAAEI,QAAR,CAAkBL,MAAM,CAAEI,UAA1B,CADa,CAA7B,EAIAH,IAAI,CAAChB,KAAL,CAAaoB,QAAb,CACAL,MAAM,CAACf,KAAP,CAAemB,UAAf,CACD,CAVD,CAYA,GAAMwB,OAAM,CAAG,QAATA,OAAS,EAAM,uBACnB,sBAAItC,QAAQ,CAACmB,OAAb,SAAI,kBAAkBoB,KAAtB,CAA6B,CAC3BC,OAAO,CAACC,GAAR,+BAA0CtD,KAA1C,EACD,CACF,CAJD,CAMA,GAAMuD,cAAa,CAAGzC,YAAY,CAACkB,OAAnC,CACA,GAAMwB,SAAQ,CAAG/C,OAAO,CAACuB,OAAzB,CACA,GAAMyB,WAAU,CAAGF,aAAnB,CAEA,GAAIC,QAAQ,EAAIC,UAAhB,CAA4B,CAE1BD,QAAQ,CAACE,aAAT,CAAuBD,UAAvB,CAAmCd,SAAnC,CAA8CQ,MAA9C,EACD,CACF,CA3B8B,CAA/B,CA6BA,GAAA7C,gBAAA,EAAU,UAAM,CACd,GAAI0C,gBAAJ,CAAW,CAETzC,qBAAqB,CAAC,UAAM,CAC1BkC,sBAAsB,GACvB,CAFoB,CAArB,CAGD,CACF,CAPD,CAOG,CAACzC,KAAD,CAAQyC,sBAAR,CAPH,EASA,GAAMkB,aAAY,CAAG,GAAAjB,oCAAA,EAAkB,SAACkB,CAAD,CAA0B,CAC/DnB,sBAAsB,GACtB,GAAIxC,QAAJ,CAAcA,QAAQ,CAAC2D,CAAD,CAAR,CACf,CAHoB,CAArB,CAKA,GAAMC,UAAS,CAAG,GAAAC,cAAA,EAAQ,UAAM,CAC9B,MAAO,CACLC,SAAS,CAAE7B,QAAQ,CAAG,CAAH,CAAO,CADrB,CAEL8B,MAAM,CAAE9B,QAAQ,CAAG,GAAH,CAAS,CAFpB,CAGL+B,aAAa,CAAE5C,UAAU,CAAI,KAAJ,CAAuB,QAH3C,CAAP,CAKD,CANiB,CAMf,CAACa,QAAD,CAAWb,UAAX,CANe,CAAlB,CAWA,MACE,8BAAC,8BAAD,CAAU,IAAV,0BACMlB,IADN,EAEE,GAAG,CAAEM,OAFP,CAGE,QAAQ,CAAEkD,YAHZ,CAIE,KAAK,CAAE,CACL7D,KAAK,CAACoE,KADD,CAELL,SAFK,CAGL5B,cAAc,CAAGE,SAAH,CAAe,CAAEG,SAAS,CAAE,EAAb,CAHxB,CAJT,CASE,aAAa,CAAEnB,SAAS,CAAG,MAAH,CAAY,MATtC,8EAWE,6BAAC,oBAAD,EAAc,QAAQ,CAAEe,QAAxB,6EAAmChC,QAAnC,CAXF,CADF,CAeD,C,aAEc,GAAAiE,gBAAA,EAAUtE,qBAAV,C"}