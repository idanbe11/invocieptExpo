{"version":3,"names":["React","useEffect","useMemo","useRef","Animated","useAnimatedStyle","useSharedValue","useDraggableFlatListContext","isWeb","useCellTranslate","typedMemo","useRefs","useAnimatedValues","CellProvider","useStableCallback","CellRendererComponent","props","item","index","onLayout","children","rest","currentIndexAnim","requestAnimationFrame","value","viewRef","cellDataRef","propsRef","containerRef","horizontalAnim","scrollOffset","activeKey","keyExtractor","horizontal","key","offset","size","translate","cellOffset","cellSize","cellIndex","indexRef","indexHasChanged","current","dragInProgress","isActive","animStyle","_translate","transform","translateX","translateY","updateCellMeasurements","onSuccess","x","y","w","h","set","measurements","onFail","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","baseStyle","elevation","zIndex","flexDirection","style"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\nimport {\n  LayoutChangeEvent,\n  MeasureLayoutOnSuccessCallback,\n  StyleProp,\n  ViewStyle,\n} from \"react-native\";\nimport Animated, {\n  useAnimatedStyle,\n  useSharedValue,\n} from \"react-native-reanimated\";\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\nimport { isWeb } from \"../constants\";\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\nimport { typedMemo } from \"../utils\";\nimport { useRefs } from \"../context/refContext\";\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\nimport CellProvider from \"../context/cellContext\";\nimport { useStableCallback } from \"../hooks/useStableCallback\";\n\ntype Props<T> = {\n  item: T;\n  index: number;\n  children: React.ReactNode;\n  onLayout?: (e: LayoutChangeEvent) => void;\n  style?: StyleProp<ViewStyle>;\n};\n\nfunction CellRendererComponent<T>(props: Props<T>) {\n  const { item, index, onLayout, children, ...rest } = props;\n\n  const currentIndexAnim = useSharedValue(index);\n\n  useEffect(() => {\n    // If we set the index immediately the newly-ordered data can get out of sync\n    // with the activeIndexAnim, and cause the wrong item to momentarily become the\n    // \"active item\", which causes a flicker.\n    requestAnimationFrame(() => {\n      currentIndexAnim.value = index;\n    });\n  }, [index]);\n\n  const viewRef = useRef<Animated.View>(null);\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\n\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\n  const {\n    activeKey,\n    keyExtractor,\n    horizontal,\n  } = useDraggableFlatListContext<T>();\n\n  const key = keyExtractor(item, index);\n  const offset = useSharedValue(-1);\n  const size = useSharedValue(-1);\n\n  const translate = useCellTranslate({\n    cellOffset: offset,\n    cellSize: size,\n    cellIndex: currentIndexAnim,\n  });\n\n  const indexRef = useRef(index);\n  const indexHasChanged = index !== indexRef.current;\n  indexRef.current = index;\n\n  const dragInProgress = !!activeKey && !indexHasChanged;\n  const isActive = dragInProgress && activeKey === key;\n\n  const animStyle = useAnimatedStyle(() => {\n    const _translate = dragInProgress ? translate.value : 0;\n    return {\n      transform: [\n        horizontalAnim.value\n          ? { translateX: _translate }\n          : { translateY: _translate },\n      ],\n    };\n  }, [dragInProgress, translate]);\n\n  const updateCellMeasurements = useStableCallback(() => {\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\n      if (isWeb && horizontal) x += scrollOffset.value;\n      const cellOffset = horizontal ? x : y;\n      const cellSize = horizontal ? w : h;\n      cellDataRef.current.set(key, {\n        measurements: { size: cellSize, offset: cellOffset },\n      });\n\n      size.value = cellSize;\n      offset.value = cellOffset;\n    };\n\n    const onFail = () => {\n      if (propsRef.current?.debug) {\n        console.log(`## on measure fail, index: ${index}`);\n      }\n    };\n\n    const containerNode = containerRef.current;\n    const viewNode = viewRef.current;\n    const nodeHandle = containerNode;\n\n    if (viewNode && nodeHandle) {\n      //@ts-ignore\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\n    }\n  });\n\n  useEffect(() => {\n    if (isWeb) {\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\n      requestAnimationFrame(() => {\n        updateCellMeasurements();\n      });\n    }\n  }, [index, updateCellMeasurements]);\n\n  const onCellLayout = useStableCallback((e: LayoutChangeEvent) => {\n    updateCellMeasurements();\n    if (onLayout) onLayout(e);\n  });\n\n  const baseStyle = useMemo(() => {\n    return {\n      elevation: isActive ? 1 : 0,\n      zIndex: isActive ? 999 : 0,\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\n    };\n  }, [isActive, horizontal]);\n\n  // changing zIndex may crash android, but seems to work ok as of RN 68:\n  // https://github.com/facebook/react-native/issues/28751\n\n  return (\n    <Animated.View\n      {...rest}\n      ref={viewRef}\n      onLayout={onCellLayout}\n      style={[\n        props.style,\n        baseStyle,\n        dragInProgress ? animStyle : { transform: [] },\n      ]}\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\n    >\n      <CellProvider isActive={isActive}>{children}</CellProvider>\n    </Animated.View>\n  );\n}\n\nexport default typedMemo(CellRendererComponent);\n"],"mappings":"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"}