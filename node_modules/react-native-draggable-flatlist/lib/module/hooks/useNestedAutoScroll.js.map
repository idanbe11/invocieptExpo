{"version":3,"names":["runOnJS","useAnimatedReaction","useDerivedValue","useSharedValue","useSafeNestableScrollContainerContext","SCROLL_POSITION_TOLERANCE","useNestedAutoScroll","params","outerScrollOffset","containerSize","scrollableRef","scrollViewSize","DUMMY_VAL","hoverOffset","activeCellSize","autoscrollSpeed","autoscrollThreshold","isDraggingCell","isTouchActiveNative","hoverScreenOffset","value","isScrolledUp","isScrolledDown","distToTopEdge","Math","max","distToBottomEdge","dist","isAtTopEdge","isAtBottomEdge","scrollTarget","cur","prev","scrollToInternal","y","current","scrollTo","animated","isAtEdge","topDisabled","bottomDisabled","isEdgeDisabled","scrollTargetDiff","abs","scrollInProgress","shouldScroll","distFromEdge","speedPct","offset","targetOffset"],"sources":["useNestedAutoScroll.tsx"],"sourcesContent":["import Animated, {\n  runOnJS,\n  useAnimatedReaction,\n  useDerivedValue,\n  useSharedValue,\n} from \"react-native-reanimated\";\nimport { State as GestureState } from \"react-native-gesture-handler\";\nimport { useSafeNestableScrollContainerContext } from \"../context/nestableScrollContainerContext\";\nimport { SCROLL_POSITION_TOLERANCE } from \"../constants\";\n\n// This is mostly copied over from the main react-native-draggable-flatlist\n// useAutoScroll hook with a few notable exceptions:\n// - Since animated values are now coming in via a callback,\n//   we won't guarantee they exist (and default them if not).\n// - Outer scrollable is a ScrollView, not a FlatList\n// TODO: see if we can combine into a single shared `useAutoScroll()` hook\n\nexport function useNestedAutoScroll(params: {\n  activeCellSize?: Animated.SharedValue<number>;\n  autoscrollSpeed?: number;\n  autoscrollThreshold?: number;\n  hoverOffset?: Animated.SharedValue<number>;\n  isDraggingCell?: Animated.SharedValue<number>;\n  isTouchActiveNative?: Animated.SharedValue<number>;\n  panGestureState?: Animated.SharedValue<GestureState | number>;\n}) {\n  const {\n    outerScrollOffset,\n    containerSize,\n    scrollableRef,\n    scrollViewSize,\n  } = useSafeNestableScrollContainerContext();\n\n  const DUMMY_VAL = useSharedValue(0);\n\n  const {\n    hoverOffset = DUMMY_VAL,\n    activeCellSize = DUMMY_VAL,\n    autoscrollSpeed = 100,\n    autoscrollThreshold = 30,\n    isDraggingCell = DUMMY_VAL,\n    isTouchActiveNative = DUMMY_VAL,\n  } = params;\n\n  const hoverScreenOffset = useDerivedValue(() => {\n    return hoverOffset.value - outerScrollOffset.value;\n  }, []);\n\n  const isScrolledUp = useDerivedValue(() => {\n    return outerScrollOffset.value - SCROLL_POSITION_TOLERANCE <= 0;\n  }, []);\n\n  const isScrolledDown = useDerivedValue(() => {\n    return (\n      outerScrollOffset.value + containerSize.value + SCROLL_POSITION_TOLERANCE >=\n      scrollViewSize.value\n    );\n  }, []);\n\n  const distToTopEdge = useDerivedValue(() => {\n    return Math.max(0, hoverScreenOffset.value);\n  }, [hoverScreenOffset]);\n\n  const distToBottomEdge = useDerivedValue(() => {\n    const dist = containerSize.value - (hoverScreenOffset.value + activeCellSize.value)\n    return Math.max(0, dist);\n  }, [hoverScreenOffset, activeCellSize, containerSize]);\n\n  const isAtTopEdge = useDerivedValue(() => {\n    return distToTopEdge.value <= autoscrollThreshold;\n  }, []);\n\n  const isAtBottomEdge = useDerivedValue(() => {\n    return distToBottomEdge.value <= autoscrollThreshold;\n  });\n\n  const scrollTarget = useSharedValue(0);\n\n  useAnimatedReaction(\n    () => {\n      return isDraggingCell.value;\n    },\n    (cur, prev) => {\n      if (cur && !prev) {\n        scrollTarget.value = outerScrollOffset.value;\n      }\n    },\n    [activeCellSize]\n  );\n\n  function scrollToInternal(y: number) {\n    scrollableRef.current?.scrollTo({ y, animated: true });\n  }\n\n  useDerivedValue(() => {\n    const isAtEdge = isAtTopEdge.value || isAtBottomEdge.value;\n    const topDisabled = isAtTopEdge.value && isScrolledUp.value;\n    const bottomDisabled = isAtBottomEdge.value && isScrolledDown.value;\n    const isEdgeDisabled = topDisabled || bottomDisabled;\n\n    const scrollTargetDiff = Math.abs(scrollTarget.value - outerScrollOffset.value);\n    const scrollInProgress = scrollTargetDiff > SCROLL_POSITION_TOLERANCE;\n\n    const shouldScroll =\n      isAtEdge &&\n      !isEdgeDisabled &&\n      isDraggingCell.value &&\n      isTouchActiveNative.value &&\n      !scrollInProgress;\n\n    const distFromEdge = isAtTopEdge.value\n      ? distToTopEdge.value\n      : distToBottomEdge.value;\n    const speedPct = 1 - distFromEdge / autoscrollThreshold;\n    const offset = speedPct * autoscrollSpeed;\n    const targetOffset = isAtTopEdge.value\n      ? Math.max(0, outerScrollOffset.value - offset)\n      : outerScrollOffset.value + offset;\n    if (shouldScroll) {\n      scrollTarget.value = targetOffset;\n      // Reanimated scrollTo is crashing on android. use 'regular' scrollTo until figured out.\n      // scrollTo(scrollViewRef, 0, scrollTarget.value, true)\n      runOnJS(scrollToInternal)(targetOffset);\n    }\n  }, [autoscrollSpeed, autoscrollThreshold, isDraggingCell]);\n\n  return null;\n}\n"],"mappings":"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"}